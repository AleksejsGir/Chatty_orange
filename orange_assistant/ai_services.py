import google.generativeai as genai
from django.conf import settings
from django.db.models import Count, Q
import logging
from datetime import datetime, timedelta
import json

logger = logging.getLogger(__name__)


def get_gemini_response(prompt: str) -> str:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Google Gemini API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç.
    """
    api_key = settings.GOOGLE_API_KEY
    if not api_key:
        logger.error("GOOGLE_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ settings.py.")
        return "–û—à–∏–±–∫–∞: –ö–ª—é—á API –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –ò–ò –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."

    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-1.5-flash-latest')

    try:
        response = model.generate_content(prompt)
        if response.parts:
            return "".join(part.text for part in response.parts if hasattr(part, 'text'))
        elif hasattr(response, 'text') and response.text:
            return response.text
        else:
            if response.candidates and response.candidates[0].content and response.candidates[0].content.parts:
                return "".join(part.text for part in response.candidates[0].content.parts if hasattr(part, 'text'))
            return "–ò–ò –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ –æ–∂–∏–¥–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ."

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å Gemini API: {e}")
        return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–∏—Å—É –ò–ò. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: {str(e)}"


def get_faq_answer(question: str, user_info: dict) -> str:
    """–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–∞–π—Ç–µ."""
    prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_info.get('username', '–∞–Ω–æ–Ω–∏–º')} –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –æ —Å–∞–π—Ç–µ Chatty Orange: '{question}'. 

    Chatty Orange - —ç—Ç–æ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
    - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ —Ç–µ–≥–∞–º–∏
    - –õ–∞–π–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç–∞–º
    - –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤
    - –ü–æ–∏—Å–∫ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è —Å –∞–≤–∞—Ç–∞—Ä–æ–º

    –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ —Å–∞–π—Ç–∞, –≤–µ–∂–ª–∏–≤–æ —É–∫–∞–∂–∏ –Ω–∞ —ç—Ç–æ."""
    return get_gemini_response(prompt)


def get_feature_explanation(feature_query: str, user_info: dict) -> str:
    """–û–±—ä—è—Å–Ω—è–µ—Ç, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∞–π—Ç–∞."""
    prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_info.get('username', '–∞–Ω–æ–Ω–∏–º')} —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ñ—É–Ω–∫—Ü–∏–∏ '{feature_query}' –Ω–∞ —Å–∞–π—Ç–µ Chatty Orange. 

    –ü–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω–∏:
    1. –ß—Ç–æ —ç—Ç–æ –∑–∞ —Ñ—É–Ω–∫—Ü–∏—è
    2. –ö–∞–∫ –µ—é –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è (–ø–æ—à–∞–≥–æ–≤–æ)
    3. –ö–∞–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ–Ω–∞ –¥–∞–µ—Ç
    4. –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

    –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É."""
    return get_gemini_response(prompt)


def get_interactive_tour_step(step_number: int, user_info: dict) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —à–∞–≥–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—É—Ä–∞."""
    tour_steps = {
        1: {
            "title": "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Chatty Orange!",
            "content": """–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –ü–æ–º–æ—â–Ω–∏–∫ üçä

            Chatty Orange - —ç—Ç–æ —É—é—Ç–Ω–∞—è —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å, –≥–¥–µ —Ç—ã –º–æ–∂–µ—à—å:
            ‚Ä¢ –î–µ–ª–∏—Ç—å—Å—è –º—ã—Å–ª—è–º–∏ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
            ‚Ä¢ –ù–∞—Ö–æ–¥–∏—Ç—å –¥—Ä—É–∑–µ–π –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
            ‚Ä¢ –û–±—â–∞—Ç—å—Å—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
            ‚Ä¢ –°–ª–µ–¥–∏—Ç—å –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –ª—é–±–∏–º—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤

            –ì–æ—Ç–æ–≤ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ? –ù–∞–∂–º–∏ "–î–∞–ª–µ–µ"!"""
        },
        2: {
            "title": "‚úçÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤",
            "content": """–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç:

            1. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç" –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            2. –ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ
            3. –î–æ–±–∞–≤—å —Ñ–æ—Ç–æ (–¥–æ 10 —à—Ç—É–∫!)
            4. –í—ã–±–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–µ–≥–∏
            5. –ù–∞–∂–º–∏ "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å"

            üí° –°–æ–≤–µ—Ç: –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å –∏–¥–µ—è–º–∏ –¥–ª—è –ø–æ—Å—Ç–∞!"""
        },
        3: {
            "title": "üí¨ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ",
            "content": """–ö–∞–∫ –æ–±—â–∞—Ç—å—Å—è –Ω–∞ Chatty Orange:

            ‚ù§Ô∏è –õ–∞–π–∫–∏ - –Ω–∞–∂–º–∏ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ –ø–æ–¥ –ø–æ—Å—Ç–æ–º
            üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ - –ø–æ–¥–µ–ª–∏—Å—å –º–Ω–µ–Ω–∏–µ–º
            üîÑ –ü–æ–¥–ø–∏—Å–∫–∏ - —Å–ª–µ–¥–∏ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏ –∞–≤—Ç–æ—Ä–∞–º–∏
            üì∞ –õ–µ–Ω—Ç–∞ - –≤—Å–µ –ø–æ—Å—Ç—ã –æ—Ç —Ç–≤–æ–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫

            –ß–µ–º –∞–∫—Ç–∏–≤–Ω–µ–µ —Ç—ã —É—á–∞—Å—Ç–≤—É–µ—à—å, —Ç–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è!"""
        },
        4: {
            "title": "üéØ –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏",
            "content": """–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

            üîç –ü–æ–∏—Å–∫ - –Ω–∞–π–¥–∏ –ø–æ—Å—Ç—ã –∏ –ª—é–¥–µ–π –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
            üè∑Ô∏è –¢–µ–≥–∏ - —Ñ–∏–ª—å—Ç—Ä—É–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ —Ç–µ–º–∞–º
            üë§ –ü—Ä–æ—Ñ–∏–ª—å - –Ω–∞—Å—Ç—Ä–æ–π –∞–≤–∞—Ç–∞—Ä –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
            üçä –Ø, —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ - –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!

            –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢–µ–ø–µ—Ä—å —Ç—ã –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é Chatty Orange! üéâ"""
        }
    }

    step_data = tour_steps.get(step_number, tour_steps[4])
    return f"<h5>{step_data['title']}</h5>{step_data['content']}"


def get_post_creation_suggestion(current_text: str, user_info: dict) -> str:
    """–ü–æ–º–æ–≥–∞–µ—Ç —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ—Å—Ç–∞."""
    if not current_text:
        prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_info.get('username', '–ê–Ω–æ–Ω–∏–º')} —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç –Ω–∞ Chatty Orange.

        –ü—Ä–µ–¥–ª–æ–∂–∏ 5 –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∏–¥–µ–π –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

        üåü **–ò–¥–µ—è 1: [–ù–∞–∑–≤–∞–Ω–∏–µ]**
        [–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –ø—Ä–∏–º–µ—Ä –Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–∞]

        –ò–¥–µ–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, —Ö–æ–±–±–∏, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç, –≤–æ–ø—Ä–æ—Å —Å–æ–æ–±—â–µ—Å—Ç–≤—É, —Ñ–æ—Ç–æ-–∏—Å—Ç–æ—Ä–∏—è."""
    else:
        prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_info.get('username', '–ê–Ω–æ–Ω–∏–º')} –ø–∏—à–µ—Ç –ø–æ—Å—Ç:
        "{current_text}"

        –î–∞–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:
        1. –ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å
        2. –ö–∞–∫–∏–µ —Ç–µ–≥–∏ –ø–æ–¥–æ–π–¥—É—Ç
        3. –ü—Ä–µ–¥–ª–æ–∂–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ

        –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º!"""

    return get_gemini_response(prompt)


def get_subscription_recommendations(user_info: dict, current_user_id: int = None) -> str:
    """–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏."""
    from django.db.models import Count
    from users.models import CustomUser
    from posts.models import Post

    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤
        recommended_users = CustomUser.objects.annotate(
            num_subscribers=Count('subscribers'),
            num_posts=Count('posts')
        ).filter(
            num_posts__gt=0  # –¢–æ–ª—å–∫–æ —Ç–µ, –∫—Ç–æ –ø–∏—Å–∞–ª –ø–æ—Å—Ç—ã
        ).order_by('-num_subscribers', '-num_posts')

        if current_user_id:
            recommended_users = recommended_users.exclude(id=current_user_id)
            # –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ—Ö, –Ω–∞ –∫–æ–≥–æ —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω
            user = CustomUser.objects.get(id=current_user_id)
            subscribed_ids = user.subscriptions.values_list('target_id', flat=True)
            recommended_users = recommended_users.exclude(id__in=subscribed_ids)

        recommended_users = recommended_users[:5]

        if not recommended_users:
            return "üçä –ü–æ–∫–∞ —á—Ç–æ –º–∞–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤, –Ω–æ —Å–∫–æ—Ä–æ –∏—Ö —Å—Ç–∞–Ω–µ—Ç –±–æ–ª—å—à–µ! –ê –ø–æ–∫–∞ —Å–æ–∑–¥–∞–π —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç!"

        authors_info = []
        for user in recommended_users:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            last_post = user.posts.order_by('-created_at').first()
            post_preview = f"–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç: {last_post.title[:30]}..." if last_post else "–ï—â–µ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤"

            authors_info.append(f"""
üî∏ **@{user.username}** ({user.num_subscribers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤, {user.num_posts} –ø–æ—Å—Ç–æ–≤)
{f'üìù –û —Å–µ–±–µ: {user.bio[:100]}...' if user.bio else ''}
üì∞ {post_preview}""")

        recommendations = "\n".join(authors_info)

        return f"""üåü **–†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤:**

{recommendations}

üí° **–°–æ–≤–µ—Ç:** –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è –Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤ —Å –ø–æ—Ö–æ–∂–∏–º–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏, —á—Ç–æ–±—ã —Ç–≤–æ—è –ª–µ–Ω—Ç–∞ –±—ã–ª–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π!"""

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ! üçä"


def check_post_content(post_text: str, user_info: dict) -> str:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º."""
    if not post_text.strip():
        return "üìù –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!"

    site_rules = """
    1. ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —É–≥—Ä–æ–∑—ã –∏ –∞–≥—Ä–µ—Å—Å–∏—è
    2. ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç 18+, –Ω–∞—Å–∏–ª–∏–µ, —à–æ–∫-–∫–æ–Ω—Ç–µ–Ω—Ç
    3. ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω —Å–ø–∞–º –∏ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞
    4. ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏
    5. ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∞ –∏ —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ —Å–ø–æ—Ä—ã
    6. ‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    7. ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ - —Ä—É—Å—Å–∫–∏–π
    """

    prompt = f"""–ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –æ—Ç {user_info.get('username', '–ê–Ω–æ–Ω–∏–º')}:
    "{post_text}"

    –ü—Ä–∞–≤–∏–ª–∞ Chatty Orange:
    {site_rules}

    –ï—Å–ª–∏ –≤—Å—ë —Ö–æ—Ä–æ—à–æ, –æ—Ç–≤–µ—Ç—å: "‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –ø–æ—Å—Ç! –ú–æ–∂–Ω–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å!"

    –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è:
    1. –£–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ
    2. –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —ç—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ
    3. –ü—Ä–µ–¥–ª–æ–∂–∏, –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

    –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–º!"""

    return get_gemini_response(prompt)


def analyze_profile_stats(user_id: int) -> str:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ—Ñ–∏–ª—è –∏ –¥–∞–µ—Ç —Å–æ–≤–µ—Ç—ã."""
    from users.models import CustomUser
    from posts.models import Post, Comment
    from subscriptions.models import Subscription

    try:
        user = CustomUser.objects.get(id=user_id)

        # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = {
            'posts_count': user.posts.count(),
            'comments_count': Comment.objects.filter(author=user).count(),
            'likes_received': sum(post.likes.count() for post in user.posts.all()),
            'subscribers_count': user.subscribers.count(),
            'subscriptions_count': user.subscriptions.count(),
            'days_on_site': (datetime.now().date() - user.created_at.date()).days
        }

        # –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        last_post = user.posts.order_by('-created_at').first()
        last_comment = Comment.objects.filter(author=user).order_by('-created_at').first()

        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @{user.username} –Ω–∞ Chatty Orange:

        üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
        - –î–Ω–µ–π –Ω–∞ —Å–∞–π—Ç–µ: {stats['days_on_site']}
        - –ü–æ—Å—Ç–æ–≤: {stats['posts_count']}
        - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {stats['comments_count']}
        - –ü–æ–ª—É—á–µ–Ω–æ –ª–∞–π–∫–æ–≤: {stats['likes_received']}
        - –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: {stats['subscribers_count']}
        - –ü–æ–¥–ø–∏—Å–æ–∫: {stats['subscriptions_count']}

        –î–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:
        1. –û—Ü–µ–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è)
        2. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ö–æ—Ä–æ—à–æ
        3. –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
        4. 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞ –¥–ª—è —Ä–æ—Å—Ç–∞

        –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∏ –±—É–¥—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º!"""

        return get_gemini_response(prompt)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª—è: {e}")
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ! üçä"


def generate_post_ideas(user_info: dict, tags: list = None) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤."""
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏ –∏ —Ç–µ–º—ã
    available_tags = ['–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '–ï–¥–∞', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', '–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ', '–°–ø–æ—Ä—Ç', '–ö–Ω–∏–≥–∏', '–ú—É–∑—ã–∫–∞', '–§–æ—Ç–æ']

    if tags:
        focus_tags = ', '.join(tags)
    else:
        focus_tags = '—Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã'

    prompt = f"""–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 5 –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –∏–¥–µ–π –¥–ª—è –ø–æ—Å—Ç–æ–≤ –≤ Chatty Orange –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_info.get('username', '–ê–Ω–æ–Ω–∏–º')}.

    –¢–µ–º–∞—Ç–∏–∫–∞: {focus_tags}
    –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏: {', '.join(available_tags)}

    –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
    üí° **–ò–¥–µ—è 1: [–ó–∞–≥–æ–ª–æ–≤–æ–∫]**
    üìù –û–ø–∏—Å–∞–Ω–∏–µ: [–ß—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å]
    üì∏ –§–æ—Ç–æ: [–ß—Ç–æ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å]
    üè∑Ô∏è –¢–µ–≥–∏: [–ü–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–µ–≥–∏]

    –ò–¥–µ–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
    - –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏ –∏ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–º–∏
    - –õ–µ–≥–∫–∏–º–∏ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    - –ü–æ–¥—Ö–æ–¥—è—â–∏–º–∏ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏"""

    return get_gemini_response(prompt)


def analyze_sentiment(text: str) -> str:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω —Ç–µ–∫—Å—Ç–∞."""
    prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
    "{text}"

    –û–ø—Ä–µ–¥–µ–ª–∏:
    1. –û–±—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ/–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ/–Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–µ)
    2. –û—Å–Ω–æ–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏
    3. –£—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏ (—Å–ø–æ–∫–æ–π–Ω—ã–π/—É–º–µ—Ä–µ–Ω–Ω—ã–π/—ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π)

    –û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç–º–æ–¥–∑–∏:
    –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: [—ç–º–æ–¥–∑–∏] [–æ–ø–∏—Å–∞–Ω–∏–µ]
    –≠–º–æ—Ü–∏–∏: [—Å–ø–∏—Å–æ–∫]
    –≠–Ω–µ—Ä–≥–∏—è: [—É—Ä–æ–≤–µ–Ω—å]"""

    return get_gemini_response(prompt)