<div class="comment-block {% if level > 0 %}nested-comment{% endif %}" data-comment-id="{{ comment.id }}">
    <div class="d-flex mb-3 pb-3 border-bottom">
        <div class="flex-shrink-0 me-3">
            {% if comment.author.avatar %}
                <img src="{{ comment.author.avatar.url }}" alt="{{ comment.author.username }}" class="post-avatar" style="width: 40px; height: 40px;">
            {% else %}
                <div class="avatar-placeholder" style="width: 40px; height: 40px; font-size: 1rem;">
                    <span>{{ comment.author.username|first|upper }}</span>
                </div>
            {% endif %}
        </div>
        <div class="flex-grow-1">
            <h6 class="mt-0 mb-1">
                <a href="{% url 'users:profile' comment.author.username %}" class="post-author-name">{{ comment.author.username }}</a>
                <small class="text-muted ms-2">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
            </h6>

            {% if not comment.is_active and user.is_staff %}
                <div class="alert alert-warning py-2 px-3 mb-2 d-inline-block">
                    <i class="fa-solid fa-eye-slash me-1"></i> Комментарий скрыт от обычных пользователей
                </div>
            {% endif %}

            <div class="comment-content" data-comment-id="{{ comment.id }}">
                <p>{{ comment.text|linebreaksbr }}</p>
            </div>

            <!-- Блок с иконками действий -->
            <div class="comment-actions mt-2 d-flex gap-2">
                <!-- Кнопка реакции -->
                <button class="btn-reaction" data-comment-id="{{ comment.id }}" title="Добавить реакцию">
                    <i class="fa-regular fa-face-smile"></i>
                </button>

                <!-- Кнопка ответа -->
                <button class="btn-reply-comment" data-comment-id="{{ comment.id }}" title="Ответить">
                    <i class="fa-regular fa-comment-dots"></i>
                </button>

                {% if user == comment.author or user.is_staff %}
                <!-- Кнопка редактирования -->
                <button class="btn-edit-comment" data-comment-id="{{ comment.id }}" title="Редактировать">
                    <i class="fa-regular fa-pen-to-square"></i>
                </button>

                <!-- Кнопка удаления -->
                <button class="btn-delete-comment" data-comment-id="{{ comment.id }}" title="Удалить">
                    <i class="fa-regular fa-trash-can"></i>
                </button>
                {% endif %}
            </div>

            <!-- Форма редактирования (изначально скрыта) -->
            <div class="edit-form-container" data-comment-id="{{ comment.id }}">
                <form method="post" class="edit-comment-form mt-2" data-comment-id="{{ comment.id }}">
                    {% csrf_token %}
                    <textarea name="text" class="form-control mb-2" rows="3">{{ comment.text }}</textarea>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-sm btn-primary">Сохранить</button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-edit">Отмена</button>
                    </div>
                </form>
            </div>

            <!-- Форма ответа (изначально скрыта) -->
            <div class="reply-form" data-comment-id="{{ comment.id }}">
                <form method="post" action="{% url 'posts:comment-reply' parent_id=comment.id %}?from={{ request.GET.from }}" class="mt-2">
                    {% csrf_token %}
                    {{ comment_form.text }}
                    <div class="mt-2">
                        <button type="submit" class="btn btn-primary btn-sm">Отправить</button>
                        <button type="button" class="btn btn-secondary btn-sm cancel-reply">Отмена</button>
                    </div>
                </form>
            </div>

            <!-- Контейнер для реакций -->
            <div class="reactions-container mt-2" data-comment-id="{{ comment.id }}">
                {% for reaction in comment.reactions.all %}
                <span class="reaction-badge" data-emoji="{{ reaction.emoji }}">
                    {{ reaction.emoji }} <span class="count">{{ reaction.count }}</span>
                </span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>