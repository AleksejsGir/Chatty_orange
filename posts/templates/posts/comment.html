{% load django_bootstrap5 %}

<div class="comment-block card mb-3 {% if level > 0 %}nested-comment{% endif %}" data-comment-id="{{ comment.id }}">
    <div class="card-body">
        <div class="d-flex">
            <div class="flex-shrink-0 me-3">
                {% if comment.author.avatar %}
                    <img src="{{ comment.author.avatar.url }}"
                         alt="{{ comment.author.username }}"
                         class="post-avatar"
                         style="width: 40px; height: 40px;">
                {% else %}
                    <div class="avatar-placeholder"
                         style="width: 40px; height: 40px; font-size: 1rem;">
                        <span>{{ comment.author.username|first|upper }}</span>
                    </div>
                {% endif %}
            </div>

            <div class="flex-grow-1 position-relative">
                <div class="comment-header mb-2">
                    <h6 class="mt-0 mb-1 d-inline-block">
                        <a href="{% url 'users:profile' comment.author.username %}"
                           class="post-author-name">{{ comment.author.username }}</a>
                        <small class="text-muted ms-2">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                    </h6>
                </div>

                {% if not comment.is_active and user.is_staff %}
                    <div class="alert alert-warning py-2 px-3 mb-2 d-inline-block">
                        <i class="fa-solid fa-eye-slash me-1"></i> ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ ÑĞºÑ€Ñ‹Ñ‚
                    </div>
                {% endif %}

                <div class="comment-content mb-2">
                    <p>{{ comment.text|linebreaksbr }}</p>
                </div>

                <!-- Ğ‘Ğ»Ğ¾Ğº Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ -->
                <div class="reactions-summary mb-2">
                    {% for reaction in comment.reactions.all %}
                        <span class="badge reaction-badge me-1 {% if request.user in reaction.users.all %}user-reaction{% endif %}"
                              data-emoji="{{ reaction.emoji }}"
                              data-comment-id="{{ comment.id }}">
                            {{ reaction.emoji }} {{ reaction.users.count }}
                        </span>
                    {% endfor %}
                </div>

                <!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° -->
                <div class="replies-container mt-2"></div>

                <!-- Ğ‘Ğ»Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ -->
                <div class="comment-actions mt-2 d-flex align-items-center gap-3">
                    {% if user.is_authenticated %}
                    <!-- Ğ ĞµĞ°ĞºÑ†Ğ¸Ğ¸ -->
                    <div class="reactions-container">
                        <button class="btn-action text-muted btn-reaction"
                                data-comment-id="{{ comment.id }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Ğ ĞµĞ°ĞºÑ†Ğ¸Ñ">
                            <i class="fa-regular fa-face-smile"></i>
                        </button>
                        <div class="quick-reactions-panel">
                            <!-- ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ÑĞ¼Ğ°Ğ¹Ğ»Ğ¸ĞºĞ¸ -->
                            <button class="btn-reaction-quick" data-emoji="ğŸ‘" data-comment-id="{{ comment.id }}">ğŸ‘</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ‘" data-comment-id="{{ comment.id }}">ğŸ‘</button>
                            <button class="btn-reaction-quick" data-emoji="â¤ï¸" data-comment-id="{{ comment.id }}">â¤ï¸</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ”¥" data-comment-id="{{ comment.id }}">ğŸ”¥</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ¥°" data-comment-id="{{ comment.id }}">ğŸ¥°</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ‘" data-comment-id="{{ comment.id }}">ğŸ‘</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ˜Š" data-comment-id="{{ comment.id }}">ğŸ˜Š</button>

                            <!-- Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑĞ¼Ğ°Ğ¹Ğ»Ğ¸ĞºĞ¸ ĞºĞ°Ğº Ğ² Telegram -->
                            <button class="btn-reaction-quick" data-emoji="ğŸ˜‚" data-comment-id="{{ comment.id }}">ğŸ˜‚</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ¤”" data-comment-id="{{ comment.id }}">ğŸ¤”</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ˜®" data-comment-id="{{ comment.id }}">ğŸ˜®</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ˜¢" data-comment-id="{{ comment.id }}">ğŸ˜¢</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ‰" data-comment-id="{{ comment.id }}">ğŸ‰</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ’©" data-comment-id="{{ comment.id }}">ğŸ’©</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ™" data-comment-id="{{ comment.id }}">ğŸ™</button>

                            <!-- Ğ•Ñ‰Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ² -->
                            <button class="btn-reaction-quick" data-emoji="ğŸ¤£" data-comment-id="{{ comment.id }}">ğŸ¤£</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ˜" data-comment-id="{{ comment.id }}">ğŸ˜</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ˜" data-comment-id="{{ comment.id }}">ğŸ˜</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ¤¯" data-comment-id="{{ comment.id }}">ğŸ¤¯</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ¥³" data-comment-id="{{ comment.id }}">ğŸ¥³</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ¤®" data-comment-id="{{ comment.id }}">ğŸ¤®</button>
                            <button class="btn-reaction-quick" data-emoji="ğŸ‘Œ" data-comment-id="{{ comment.id }}">ğŸ‘Œ</button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° "ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ" Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ğ½ĞµĞ²Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ² -->
                    {% if level == 0 %}
                    <button class="btn-reply reply-button-container"
                            data-comment-id="{{ comment.id }}"
                            data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            title="ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ">
                        <i class="fa-regular fa-comment-dots me-1"></i>
                        {% if comment.replies_count > 0 %}
                        <span class="badge bg-secondary rounded-pill ms-1">{{ comment.replies_count }}</span>
                        {% endif %}
                    </button>
                    {% endif %}

                    <!-- Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ -->
                    {% if user == comment.author or user.is_staff %}
                        <button class="btn-action text-primary btn-edit-comment"
                                data-comment-id="{{ comment.id }}"
                                data-original-text="{{ comment.text|escape }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ">
                            <i class="fa-regular fa-pen-to-square"></i>
                        </button>
                    {% endif %}

                    <!-- Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ -->
                    {% if user == comment.author or user.is_staff %}
                        <form method="post"
                              action="{% url 'posts:comment-delete' pk=comment.pk %}"
                              class="d-inline">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn-action text-danger"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"
                                    onclick="return confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹?')">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                        </form>
                    {% endif %}
                </div>

                <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ -->
                <div class="edit-form mt-3 d-none">
                    <form method="post"
                          action="{% url 'posts:comment-update' pk=comment.pk %}"
                          class="edit-comment-form"
                          data-comment-id="{{ comment.id }}">
                        {% csrf_token %}
                        <textarea name="text" class="form-control mb-2">{{ comment.text }}</textarea>
                        <div class="mt-2">
                            <button type="submit" class="btn btn-primary btn-sm">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
                            <button type="button" class="btn btn-secondary btn-sm cancel-edit">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² -->
    <div class="replies mt-3 d-none">
        {% for reply in comment.replies.all %}
            {% include 'posts/comment.html' with comment=reply level=level|add:1 %}
        {% endfor %}
    </div>
</div>